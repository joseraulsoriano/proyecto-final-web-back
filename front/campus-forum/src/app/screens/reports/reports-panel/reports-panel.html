<div class="reports-panel">
  <div class="panel-header">
    <h1>Panel de Moderación</h1>
    <select [(ngModel)]="selectedStatus" (change)="onStatusChange()" class="filter-select">
      <option value="">Todos los estados</option>
      <option value="PENDING">Pendientes</option>
      <option value="REVIEWED">Revisados</option>
      <option value="RESOLVED">Resueltos</option>
      <option value="DISMISSED">Descartados</option>
    </select>
  </div>

  @if (error) {
    <div class="error-alert">{{ error }}</div>
  }

  @if (loading) {
    <div class="loading">Cargando reportes...</div>
  } @else if (reports.length === 0) {
    <div class="empty-state">No hay reportes para mostrar</div>
  } @else {
    <div class="reports-list">
      @for (report of reports; track report.id) {
        <div class="report-card">
          <div class="report-header">
            <div class="report-type">
              @if (report.type === 'POST') {
                <svg class="type-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              } @else {
                <svg class="type-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
              }
              <span class="report-type-text">{{ report.type === 'POST' ? 'Publicación' : 'Comentario' }}</span>
              <span class="badge" [class]="getStatusBadgeClass(report.status)">
                {{ report.status }}
              </span>
            </div>
            <div class="report-date">{{ formatDate(report.created_at) }}</div>
          </div>

          <div class="report-content">
            <div class="reported-content">
              @if (report.type === 'POST') {
                @if (report.post) {
                  <div class="content-preview">
                    <strong>Post:</strong> {{ report.post.title }}
                  </div>
                } @else {
                  <div class="content-preview content-deleted">
                    <strong>Post:</strong> <em>El contenido reportado ya no está disponible (fue eliminado)</em>
                  </div>
                }
              }
              @if (report.type === 'COMMENT') {
                @if (report.comment) {
                  <div class="content-preview">
                    <strong>Comentario:</strong> {{ report.comment.content?.substring(0, 100) }}...
                  </div>
                } @else {
                  <div class="content-preview content-deleted">
                    <strong>Comentario:</strong> <em>El contenido reportado ya no está disponible (fue eliminado)</em>
                  </div>
                }
              }
            </div>

            <div class="report-reason">
              <strong>Motivo:</strong>
              <p>{{ report.reason }}</p>
            </div>

            <div class="report-info">
              <p><strong>Reportado por:</strong> {{ report.reported_by.full_name }}</p>
              @if (report.reviewed_by) {
                <p><strong>Revisado por:</strong> {{ report.reviewed_by.full_name }}</p>
              }
              @if (report.action_taken) {
                <p><strong>Acción tomada:</strong> {{ report.action_taken }}</p>
              }
            </div>
          </div>

          <div class="report-actions">
            @if (report.status === ReportStatus.PENDING) {
              <button class="btn btn-warning" (click)="reviewReport(report)" [disabled]="loading">
                Revisar
              </button>
              <button class="btn btn-success" (click)="openResolveModal(report)" [disabled]="loading">
                Resolver
              </button>
              <button class="btn btn-secondary" (click)="dismissReport(report)" [disabled]="loading">
                Descartar
              </button>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Modal para resolver reporte -->
  @if (showActionModal && selectedReport) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Resolver Reporte</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Acción tomada: <span class="required">*</span></label>
            <textarea
              [(ngModel)]="actionTaken"
              class="form-control"
              rows="4"
              placeholder="Describe la acción tomada (ej: 'Post archivado', 'Comentario eliminado', 'Contenido revisado y aprobado')"
              required
            ></textarea>
            <small class="form-help">Describe qué acción se tomó para resolver este reporte</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()" [disabled]="loading">
            Cancelar
          </button>
          <button class="btn btn-success" (click)="resolveReport()" [disabled]="loading || !actionTaken || actionTaken.trim().length === 0">
            @if (loading) {
              Resolviendo...
            } @else {
              Resolver
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Modal para descartar reporte -->
  <app-confirm-dismiss-report
    [isOpen]="showDismissModal"
    [reportType]="reportToDismiss?.type || ''"
    [reportReason]="reportToDismiss?.reason || ''"
    (confirm)="confirmDismissReport()"
    (cancel)="closeDismissModal()">
  </app-confirm-dismiss-report>
</div>

